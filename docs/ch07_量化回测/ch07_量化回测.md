# 07_é‡åŒ–å›æµ‹

ç›®å½•

7.1 pandasè®¡ç®—ç­–ç•¥è¯„ä¼°æŒ‡æ ‡

7.2 èšå®½å¹³å°é‡åŒ–å›æµ‹å®è·µ

7.3 Backtraderé‡åŒ–å›æµ‹æ¡†æ¶å®è·µ

7.4 BigQuanté‡åŒ–æ¡†æ¶å®æˆ˜

7.5 æ‰‹å†™å›æµ‹ä»£ç 

## 7.1 pandasè®¡ç®—ç­–ç•¥è¯„ä¼°æŒ‡æ ‡
æœ¬ç« èŠ‚ä»‹ç»å…³äºé‡‘èé‡åŒ–åˆ†æçš„ä¸€äº›åŸºæœ¬æ¦‚å¿µï¼Œå¦‚å¹´åæ”¶ç›Šç‡ã€åŸºå‡†å¹´åŒ–æ”¶ç›Šç‡ã€æœ€å¤§å›æ’¤ç­‰ã€‚åœ¨ä¸¥æ ¼çš„é‡åŒ–ç­–ç•¥å›æµ‹ä¸­ï¼Œè¿™äº›æ¦‚å¿µéƒ½æ˜¯éœ€è¦æŒæ¡å¹¶ç†Ÿç»ƒä½¿ç”¨çš„ï¼Œè¿™æ ·èƒ½å¤Ÿå…¨é¢çš„è¯„ä¼°é‡åŒ–ç­–ç•¥ã€‚å¸‚é¢ä¸Šï¼Œå¾ˆå¤šç­–ç•¥å›æµ‹ç¬¼ç»Ÿåœ°ä½¿ç”¨æ‰€è°“çš„â€œèƒœç‡â€æ¥ç¡®å®šç­–ç•¥çš„å¥½åï¼Œè¿™æ˜¯ä¸€ç§éå¸¸ä¸šä½™è€Œä¸”ä¸å¯é çš„åˆ†ææ–¹æ³•ã€‚åœ¨è¡¡é‡åŸºé‡‘ä¸šç»©å¥½åçš„æ—¶å€™ï¼Œå¤§éƒ¨åˆ†äººä¹Ÿåªæ˜¯çœ‹åŸºé‡‘çš„å¹´åŒ–æ”¶ç›Šï¼Œå¿½ç•¥äº†åŸºé‡‘çš„é£é™©æƒ…å†µï¼ˆæ³¢åŠ¨ç‡ï¼‰ã€‚å¸‚åœºä¸­å……æ–¥ç€å¤§é‡ç±»ä¼¼çš„ä¸šä½™çš„åˆ†ææ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•å¯¼è‡´å¾ˆå¤šæ‰€è°“çš„å›æµ‹çœ‹èµ·æ¥å¾ˆç¾å¥½ï¼Œå…¶å®åœ¨ç»Ÿè®¡ä¸Šæ ¹æœ¬ç«™ä¸ä½è„šï¼Œå³æ‰€è°“çš„â€œç»Ÿè®¡éª—å±€â€ã€‚
å› æ­¤åœ¨é‡åŒ–å›æµ‹è¿‡ç¨‹ä¸­ï¼Œéœ€è¦ä»æ”¶ç›Šã€ç¨³å®šæ€§ã€èƒœç‡ã€é£é™©å››ä¸ªæ–¹é¢æ¥ç»¼åˆè¯„ä¼°ç­–ç•¥å¥½åã€‚ç†Ÿç»ƒæŒæ¡è¯„ä¼°æŒ‡æ ‡ï¼Œè¿˜èƒ½å¤Ÿå¸®åŠ©å¤§å®¶è¯†åˆ«ä¸€äº›ç»å…¸â€œéª—å±€â€ï¼Œå¦‚
- åªå±•ç¤ºåŸºé‡‘çš„å¹´åŒ–æ”¶ç›Šï¼Œè€Œä¸æåŸºé‡‘çš„æ³¢åŠ¨ç‡æˆ–è€…æœ€å¤§å›æ’¤
- ä½¿ç”¨å‘¨æ”¶ç›Šç‡æ¥è®¡ç®—å¤æ™®æ¯”ç‡ï¼Œè€Œä¸æ˜¯ä½¿ç”¨æ—¥æ”¶ç›Šç‡æ¥è®¡ç®—

### æ•°æ®å‡†å¤‡
ä¸ºäº†å¸®åŠ©å¤§å®¶æ·±å…¥äº†è§£æŒ‡æ ‡è®¡ç®—é€»è¾‘å’Œå®ç°æ–¹å¼ï¼Œæœ¬ç« èŠ‚é‡‡ç”¨æŒ‡æ ‡è®²è§£å’Œä»£ç å®ç°ç›¸ç»“åˆçš„æ–¹å¼è¿›è¡Œè®²è§£ã€‚å†å…·ä½“è®¡ç®—è¿‡ç¨‹ä¸­ï¼Œé€‰æ‹©çš„ç›®æ ‡æ ‡çš„æ˜¯è´µå·èŒ…å°ï¼ˆ600519.SHï¼‰ã€å·¥å•†é“¶è¡Œï¼ˆ601398.SHï¼‰ã€ä¸­å›½å¹³å®‰ï¼ˆ601318.SHï¼‰ï¼Œç­–ç•¥åŸºå‡†æ˜¯æ²ªæ·±300æŒ‡æ•°ï¼ˆ000300.XSHGï¼‰ï¼Œç­–ç•¥é‡‡ç”¨æœ€ç®€å•çš„æ–¹å¼ï¼šä¹°å…¥æŒæœ‰ã€‚æŒæœ‰å‘¨æœŸä¸º20180101 - 20221231ï¼Œå…±1826ä¸ªè‡ªç„¶æ—¥ã€‚æ•°æ®è·å–å¦‚ä¸‹æ‰€ç¤º
```python
import pandas as pd  
import numpy as np
import matplotlib.pyplot as plt
import tushare as ts
%matplotlib inline   

# æ— è§†warning
import warnings
warnings.filterwarnings("ignore")

# æ­£å¸¸æ˜¾ç¤ºç”»å›¾æ—¶å‡ºç°çš„ä¸­æ–‡å’Œè´Ÿå·
from pylab import mpl
mpl.rcParams['font.sans-serif']=['SimHei']
mpl.rcParams['axes.unicode_minus']=False

#èµ·å§‹å’Œç»“æŸæ—¥æœŸå¯ä»¥è‡ªè¡Œè¾“å…¥ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤
def get_data(code, start_date, end_date):
    # é…ç½® tushare token
    my_token = 'XXXXX'  
    pro = ts.pro_api(my_token)

    df = pro.daily(ts_code=code, start_date=start_date, end_date=end_date)
    df.index = pd.to_datetime(df.trade_date)

    return df.close

#ä»¥ä¸Šè¯ç»¼æŒ‡ã€è´µå·èŒ…å°ã€å·¥å•†é“¶è¡Œã€ä¸­å›½å¹³å®‰ä¸ºä¾‹
stocks={
    '600519.SH':'è´µå·èŒ…å°',
    '601398.SH':'å·¥å•†é“¶è¡Œ',
    '601318.SH':'ä¸­å›½å¹³å®‰'
}

df = pd.DataFrame()
for code,name in stocks.items():
    df[name] = get_data(code, '20180101', '20221231')

# æŒ‰ç…§æ—¥æœŸæ­£åº
df = df.sort_index()

# æœ¬åœ°è¯»å…¥æ²ªæ·±300åˆå¹¶
df_base = pd.read_csv('000300.XSHG_2018_2022.csv')
df_base.index = pd.to_datetime(df_base.trade_date)
df['æ²ªæ·±300'] = df_base['close']
```

### å‡€å€¼æ›²çº¿
å‡€å€¼æ›²çº¿æ˜¯ä¸€ç»„æ—¶é—´åºåˆ—çš„æ›²çº¿ï¼Œå…¶å«ä¹‰è¡¨ç¤ºä¸ºè‚¡ç¥¨æˆ–åŸºé‡‘åœ¨ä¸åŒæ—¶é—´çš„ä»·å€¼ç›¸å¯¹äºæœŸåˆçš„ä»·å€¼çš„å€æ•°ã€‚ å†å…·ä½“åˆ†æä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å°†æœŸåˆä»·æ ¼å®šä½1ï¼Œé‚£ä¹ˆå¦‚æœä½ åœ¨å½“å‰æ—¶é—´ç‚¹æ‰‹é‡Œçš„å‡€å€¼æ˜¯1.4ï¼Œå°±æ„å‘³ç€å½“å‰æ—¶é—´çš„èµ„äº§ä»·å€¼æ˜¯æœŸåˆçš„1.4å€ã€‚
```python
# ä»¥ç¬¬ä¸€äº¤æ˜“æ—¥2018å¹´1æœˆ1æ—¥æ”¶ç›˜ä»·ä¸ºåŸºç‚¹ï¼Œè®¡ç®—å‡€å€¼å¹¶ç»˜åˆ¶å‡€å€¼æ›²çº¿
df_worth = df / df.iloc[0]
df_worth.plot(figsize=(15,6))
plt.title('è‚¡ä»·å‡€å€¼èµ°åŠ¿', fontsize=10)
plt.xticks(pd.date_range('20180101','20221231',freq='Y'),fontsize=10)
plt.show()
```
![07_é‡åŒ–å›æµ‹_å‡€å€¼æ›²çº¿](ch07_1_1.png)

### å¹´åŒ–æ”¶ç›Šç‡

**ç´¯è®¡æ”¶ç›Šç‡**ï¼š

$R_t = \frac{P_T - P_{t}} {P_{t}}$

$P_T$ è¡¨ç¤ºåœ¨æœŸæœ«èµ„äº§çš„ä»·æ ¼

$P_{t}$ è¡¨ç¤ºæœŸåˆèµ„äº§ä»·æ ¼ã€‚

**å¹´åŒ–æ”¶ç›Šç‡**ï¼š

$R_p = (1 + R)^\frac{m}{n} - 1$

$R$ è¡¨ç¤ºæœŸé—´æ€»æ”¶ç›Šç‡ï¼Œmæ˜¯ä¸nï¼ˆå¯ä»¥æ˜¯å¤©æ•°ã€å‘¨æ•°ã€æœˆæ•°ï¼‰ç›¸å¯¹åº”çš„è®¡ç®—å‘¨æœŸï¼Œæ ¹æ®è®¡ç®—æƒ¯ä¾‹ï¼Œm=252ã€52ã€12åˆ†åˆ«æŒ‡ä»£æ—¥ã€å‘¨ã€æœˆå‘å¹´åŒ–çš„è½¬æ¢ï¼›nä¸ºæœŸé—´è‡ªç„¶æ—¥å¤©æ•°ã€‚

å¹´åŒ–æ”¶ç›Šçš„ä¸€ä¸ªç›´è§‚çš„ç†è§£æ˜¯ï¼Œå‡è®¾æŒ‰ç…§æŸç§ç›ˆåˆ©èƒ½åŠ›ï¼Œæ¢ç®—æˆä¸€å¹´çš„æ”¶ç›Šå¤§æ¦‚èƒ½æœ‰å¤šå°‘ã€‚è¿™ä¸ªæ¦‚å¿µå¸¸å¸¸ä¼šå­˜åœ¨è¯¯å¯¼æ€§ï¼Œæ¯”å¦‚ï¼Œè¿™ä¸ªæœˆè‚¡ç¥¨èµšäº†5%ï¼Œåœ¨éšæœºæ³¢åŠ¨çš„å¸‚åœºä¸­ï¼Œè¿™æ˜¯å¾ˆæ­£å¸¸çš„ç°è±¡ã€‚å¦‚æœæ®æ­¤å·ç§°å¹´åŒ–æ”¶ç›Šä¸º5%Ã—12ä¸ªæœˆ=60%ï¼Œè¿™å°±æ˜¾å¾—ä¸å¤ªå¯ä¿¡äº†ï¼Œå®é™…ä¸Šæ¯ä¸ªæœˆçš„æ”¶ç›Šä¸å¯èƒ½éƒ½è¿™ä¹ˆç¨³å®šã€‚æ‰€ä»¥åœ¨å¬åˆ°æœ‰äººè¯´å¹´åŒ–æ”¶ç›Šçš„æ—¶å€™ï¼Œéœ€è¦ç‰¹åˆ«ç•™æ„ä¸€ä¸‹å…·ä½“çš„æƒ…å†µï¼Œå¦åˆ™å¾ˆå®¹æ˜“è¢«è¯¯å¯¼ã€‚


```python
# åŒºé—´ç´¯è®¡æ”¶ç›Šç‡(ç»å¯¹æ”¶ç›Šç‡)
total_return = df_worth.iloc[-1]-1
total_return = pd.DataFrame(total_return.values,columns=['ç´¯è®¡æ”¶ç›Šç‡'],index=total_return.index)
total_return

# å¹´åŒ–æ”¶ç›Šç‡
annual_return = pd.DataFrame((1 + total_return.values) ** (252 / 1826) - 1,columns=['å¹´åŒ–æ”¶ç›Šç‡'],index=total_return.index)
annual_return
```

![07_é‡åŒ–å›æµ‹_å¹´åŒ–æ”¶ç›Šç‡](ch07_1_2.png)


### æ³¢åŠ¨ç‡
æ³¢åŠ¨ç‡æ˜¯å¯¹æ”¶ç›Šå˜åŠ¨çš„ä¸€ç§è¡¡é‡ï¼Œæœ¬è´¨ä¹Ÿæ˜¯é£é™©ï¼Œæ³¢åŠ¨ç‡å’Œé£é™©ï¼Œéƒ½æ˜¯ç”¨æ¥è¡¡é‡æ”¶ç›Šç‡çš„ä¸ç¡®å®šæ€§çš„ã€‚æˆ‘ä»¬ç”¨æ–¹å·®æ¥è¡¨ç¤ºï¼Œå¹´æ³¢åŠ¨ç‡ç­‰äºç­–ç•¥æ”¶ç›Šå’Œæ— é£é™©æ”¶ç›Šçš„æ ‡å‡†å·®é™¤ä»¥å…¶å‡å€¼ï¼Œå†é™¤ä»¥äº¤æ˜“æ—¥å€’æ•°çš„å¹³æ–¹æ ¹ï¼Œé€šå¸¸äº¤æ˜“æ—¥å–252å¤©ã€‚

$Volatility = \sqrt{\frac{252}{n-1} \sum\limits_{i=1}^n (r_p - \hat{r_p})^2}$



$r_p$è¡¨ç¤ºç­–ç•¥æ¯æ—¥æ”¶ç›Šç‡

$\hat{r_p}$è¡¨ç¤ºç­–ç•¥æ¯æ—¥æ”¶ç›Šç‡çš„å¹³å‡å€¼

$n$è¡¨ç¤ºç­–ç•¥æ‰§è¡Œå¤©æ•°

```python
df_return = df / df.shift(1) - 1
df_return = ((df_return.iloc[1:] - df_return.mean()) ** 2)

volatility = pd.DataFrame(np.sqrt(df_return.sum() * 252 / (1826-1)),columns=['æ³¢åŠ¨ç‡'],index=total_return.index)
volatility
```

![07_é‡åŒ–å›æµ‹_æ³¢åŠ¨ç‡](ch07_1_3.png)

### æœ€å¤§å›æ’¤
é€‰å®šå‘¨æœŸå†…ä»»ä¸€å†å²æ—¶ç‚¹å¾€åæ¨ï¼Œäºæœ€ä½ç‚¹æ—¶çš„æ”¶ç›Šç‡å›æ’¤å¹…åº¦çš„æœ€å¤§å€¼ã€‚æœ€å¤§å›æ’¤ç”¨æ¥æè¿°å¯èƒ½å‡ºç°çš„æœ€ç³Ÿç³•çš„æƒ…å†µã€‚æœ€å¤§å›æ’¤æ˜¯ä¸€ä¸ªé‡è¦çš„é£é™©æŒ‡æ ‡ï¼Œå¯¹äºé‡åŒ–ç­–ç•¥äº¤æ˜“ï¼Œè¯¥æŒ‡æ ‡æ¯”æ³¢åŠ¨ç‡è¿˜é‡è¦ã€‚
Pä¸ºæŸä¸€å¤©çš„å‡€å€¼ï¼Œiä¸ºæŸä¸€å¤©ï¼Œjä¸ºiåçš„æŸä¸€å¤©ï¼ŒPiä¸ºç¬¬iå¤©çš„äº§å“å‡€å€¼ï¼ŒPjåˆ™æ˜¯Piåé¢æŸä¸€å¤©çš„å‡€å€¼

åˆ™è¯¥èµ„äº§çš„æœ€å¤§å›æ’¤è®¡ç®—å¦‚ä¸‹ï¼š

$MaxDrawdown = \frac{max(P_i - P_j)} {P_{i}}$

```python
def max_drawdown_cal(df):
    md = ((df.cummax() - df)/df.cummax()).max()
    return round(md, 4)

max_drawdown = {}

stocks={
    '600519.SH':'è´µå·èŒ…å°',
    '601398.SH':'å·¥å•†é“¶è¡Œ',
    '601318.SH':'ä¸­å›½å¹³å®‰',
    '000300.XSHG': 'æ²ªæ·±300'
}

for code,name in stocks.items():
    max_drawdown[name]=max_drawdown_cal(df[name])

max_drawdown = pd.DataFrame(max_drawdown,index=['æœ€å¤§å›æ’¤']).T
max_drawdown

```

![07_é‡åŒ–å›æµ‹_æœ€å¤§å›æ’¤](ch07_1_4.png)

### Alphaç³»æ•°å’ŒBetaç³»æ•°
å…³äºAlphaç³»æ•°å’ŒBetaç³»æ•°æœ‰å¾ˆå¤šè¯¦å°½çš„è§£é‡Šï¼Œè¿™é‡Œå°±ç”¨æœ€ç®€å•çš„ä¸€å¥è¯æ¥å¸®åŠ©å¤§å®¶ç®€å•ç†è§£ã€‚Betaç³»æ•°ä»£è¡¨æŠ•èµ„ä¸­çš„ç³»ç»Ÿé£é™©ï¼Œè€Œåœ¨æŠ•èµ„ä¸­é™¤äº†ç³»ç»Ÿé£é™©å¤–è¿˜é¢ä¸´ç€å¸‚åœºæ³¢åŠ¨æ— å…³çš„éç³»ç»Ÿæ€§é£é™©ã€‚ Alphaç³»æ•°å°±ä»£è¡¨æŠ•èµ„ä¸­çš„éç³»ç»Ÿæ€§é£é™©ï¼Œæ˜¯æŠ•èµ„è€…è·å¾—ä¸å¸‚åœºæ³¢åŠ¨æ— å…³çš„å›æŠ¥ã€‚

å¯ä»¥ä½¿ç”¨èµ„æœ¬èµ„äº§å®šä»·æ¨¡å‹ï¼ˆCAPMï¼‰æ¥ä¼°è®¡ç­–ç•¥çš„betaå’Œalphaå€¼ï¼ŒCAPMæ¨¡å‹ä¸ºï¼š

$E(r_i) = r_f + \beta(E(r_m) - r_f)$

$E(r_i)$è¡¨ç¤ºæŠ•èµ„ç»„åˆçš„é¢„æœŸæ”¶ç›Šç‡

$r_f$è¡¨ç¤ºæ— é£é™©åˆ©ç‡

$r_m$è¡¨ç¤ºå¸‚åœºæŒ‡æ•°æ”¶ç›Šç‡

$\beta$è¡¨ç¤ºè‚¡å¸‚æ³¢åŠ¨é£é™©ä¸æŠ•èµ„æœºä¼šä¸­çš„ç»“æ„æ€§ä¸ç³»ç»Ÿæ€§é£é™©ã€‚


å› æ­¤CAPMçš„è®¡é‡æ¨¡å‹å¯ä»¥è¡¨ç¤ºä¸º

$r_i = \alpha + \beta r_m + \epsilon_\alpha$

$\epsilon_\alpha$è¡¨ç¤ºéšæœºæ‰°åŠ¨ï¼Œå¯ä»¥ç†è§£ä¸ºä¸ªä½“é£é™©

```python
from scipy import stats

#è®¡ç®—æ¯æ—¥æ”¶ç›Šç‡ æ”¶ç›˜ä»·ç¼ºå¤±å€¼ï¼ˆåœç‰Œï¼‰ï¼Œä½¿ç”¨å‰å€¼ä»£æ›¿
rets=(df.iloc[:,:4].fillna(method='pad')).apply(lambda x:x/x.shift(1)-1)[1:]

#å¸‚åœºæŒ‡æ•°ä¸ºxï¼Œä¸ªè‚¡æ”¶ç›Šç‡ä¸ºy
x = rets.iloc[:,3].values
y = rets.iloc[:,:3].values
capm = pd.DataFrame()
alpha = []
beta = []
for i in range(3):
    b, a, r_value, p_value, std_err=stats.linregress(x,y[:,i])
    #alphaè½¬åŒ–ä¸ºå¹´åŒ–
    alpha.append(round(a*250,3))
    beta.append(round(b,3))
    
capm['alpha']=alpha
capm['beta']=beta
capm.index=rets.columns[:3]
#è¾“å‡ºç»“æœï¼š
capm
```

![07_é‡åŒ–å›æµ‹_alpha_beta](ch07_1_5.png)

### å¤æ™®æ¯”ç‡
å¤æ™®æ¯”ç‡ï¼ˆsharpe ratioï¼‰è¡¨ç¤ºæ¯æ‰¿å—ä¸€å•ä½æ€»é£é™©ï¼Œä¼šäº§ç”Ÿå¤šå°‘çš„è¶…é¢æŠ¥é…¬ï¼Œè¯¥æ¯”ç‡è¶Šé«˜ã€‚å¤æ™®æ¯”ç‡æ˜¯åœ¨èµ„æœ¬èµ„äº§å®šä»·æ¨¡å‹è¿›ä¸€æ­¥å‘å±•å¾—æ¥çš„ã€‚

$SharpeRatio = \frac{R_p - R_f} {\sigma_p}$

$R_p$è¡¨ç¤ºç­–ç•¥å¹´åŒ–æ”¶ç›Šç‡

$R_F$è¡¨ç¤ºæ— é£é™©æ”¶ç›Šç‡

$\sigma_p$è¡¨ç¤ºå¹´åŒ–æ ‡å‡†å·®



```python
# è¶…é¢æ”¶ç›Šç‡ä»¥æ— é£é™©æ”¶ç›Šç‡ä¸ºåŸºå‡† å‡è®¾æ— é£é™©æ”¶ç›Šç‡ä¸ºå¹´åŒ–3%
ex_return=rets - 0.03/250

# è®¡ç®—å¤æ™®æ¯”ç‡
sharpe_ratio=np.sqrt(len(ex_return))*ex_return.mean()/ex_return.std()
sharpe_ratio=pd.DataFrame(sharpe_ratio,columns=['å¤æ™®æ¯”ç‡'])
sharpe_ratio
```
![07_é‡åŒ–å›æµ‹_å‡€å€¼æ›²çº¿](ch07_1_6.png)


### ä¿¡æ¯æ¯”ç‡
ä¿¡æ¯æ¯”ç‡å«ä¹‰ä¸å¤æ™®æ¯”ç‡ç±»ä¼¼ï¼Œåªä¸è¿‡å…¶å‚ç…§åŸºå‡†ä¸æ˜¯æ— é£é™©æ”¶ç›Šç‡ï¼Œè€Œæ˜¯ç­–ç•¥çš„å¸‚åœºåŸºå‡†æ”¶ç›Šç‡ã€‚

$InformationRatio = \frac{R_p - R_f} {\sigma_t}$

$R_p$è¡¨ç¤ºç­–ç•¥å¹´åŒ–æ”¶ç›Šç‡

$R_F$è¡¨ç¤ºæ— é£é™©æ”¶ç›Šç‡

$\sigma_t$è¡¨ç¤ºç­–ç•¥ä¸åŸºå‡†æ¯æ—¥æ”¶ç›Šç‡å·®å€¼çš„å¹´åŒ–æ ‡å‡†å·®



```python
###ä¿¡æ¯æ¯”ç‡
ex_return = pd.DataFrame() 
ex_return['è´µå·èŒ…å°']=rets.iloc[:,0]-rets.iloc[:,3]
ex_return['å·¥å•†é“¶è¡Œ']=rets.iloc[:,1]-rets.iloc[:,3]
ex_return['ä¸­å›½å¹³å®‰']=rets.iloc[:,2]-rets.iloc[:,3]

#è®¡ç®—ä¿¡æ¯æ¯”ç‡
information_ratio = np.sqrt(len(ex_return))*ex_return.mean()/ex_return.std()
#ä¿¡æ¯æ¯”ç‡çš„è¾“å‡ºç»“æœ
information_ratio = pd.DataFrame(information_ratio,columns=['ä¿¡æ¯æ¯”ç‡'])
information_ratio

```
![07_é‡åŒ–å›æµ‹_å‡€å€¼æ›²çº¿](ch07_1_7.png)




## 7.2 èšå®½å¹³å°é‡åŒ–å›æµ‹å®è·µ

### å¹³å°ä»‹ç»

èšå®½ï¼ˆhttps://www.joinquant.com/ï¼‰ æˆç«‹äº2015å¹´5æœˆï¼Œæ˜¯ä¸€å®¶é‡åŒ–äº¤æ˜“å¹³å°ï¼Œä¸ºæŠ•èµ„è€…æä¾›åšé‡åŒ–äº¤æ˜“çš„å·¥å…·ä¸æœåŠ¡ï¼Œå¸®åŠ©æŠ•èµ„è€…æ›´å¥½åœ°åšé‡åŒ–äº¤æ˜“ã€‚
æ•´ä½“æ¥çœ‹ï¼Œèšå®½å…·æœ‰ä»¥ä¸‹å‡ ç‚¹ä¼˜åŠ¿
1. èšå®½è®©åšé‡åŒ–äº¤æ˜“çš„æˆæœ¬æå¤§é™ä½ 
2. æä¾›å¤šç§ä¼˜è´¨çš„ä¾¿äºå–ç”¨çš„æ•°æ® 
3. æä¾›æŠ•èµ„ç ”ç©¶åŠŸèƒ½ï¼Œä¾¿äºè‡ªç”±åœ°ç»Ÿè®¡ã€ç ”ç©¶ã€å­¦ä¹ ç­‰ 
4. æä¾›å¤šç§çš„ç­–ç•¥è¯„ä»·æŒ‡æ ‡ä¸è¯„ä»·ç»´åº¦ 
5. æ”¯æŒå¤šç§ç­–ç•¥çš„ç¼–å†™ã€å›æµ‹ã€æ¨¡æ‹Ÿã€å®ç›˜
6. å…·å¤‡ä¸°å¯Œä¸”æ´»è·ƒçš„é‡åŒ–ç¤¾åŒºï¼Œå¯ä»¥å‘å¸–ã€å­¦ä¹ ã€æ¯”èµ›ç­‰ã€‚

### ç­–ç•¥å®ç°
æœ¬éƒ¨åˆ†å°†ä»‹ç»å¦‚ä½•åœ¨èšå®½å¹³å°å®ç°ä¸€ä¸ªåŒå‡çº¿ç­–ç•¥ï¼ˆå…·ä½“å‚ç…§ch05æ‹©æ—¶ç­–ç•¥ï¼‰ï¼Œå¹¶ä¸”åœ¨èšå®½å¹³å°ä¸Šè¿›è¡Œå›æµ‹ï¼Œ
æ¥æµ‹è¯•æ•´ä½“æ”¶ç›Šç‡ã€‚

ç­–ç•¥ä»£ç å¦‚ä¸‹ï¼Œæ ¸å¿ƒç‚¹æœ‰ï¼š
- é€‰æ‹©æ ‡çš„ä¸ºï¼š002594.XSHE æ¯”äºšè¿ª
- é€‰æ‹©åŸºå‡†ä¸ºï¼š000300.XSHG æ²ªæ·±300
- ç­–ç•¥ä¸ºï¼šå½“5æ—¥çº¿é‡‘å‰10æ—¥çº¿ï¼Œå…¨ä»“ä¹°å…¥ï¼›å½“5æ—¥çº¿æ­»å‰10æ—¥çº¿å…¨ä»“å–å‡ºã€‚
  
```python
# å¯¼å…¥å‡½æ•°åº“
from jqdata import *

# åˆå§‹åŒ–å‡½æ•°ï¼Œè®¾å®šåŸºå‡†ç­‰ç­‰
def initialize(context):
    # è®¾å®šæ²ªæ·±ä¸Šè¯ä½œä¸ºåŸºå‡†
    set_benchmark('000300.XSHG')
    # å¼€å¯åŠ¨æ€å¤æƒæ¨¡å¼(çœŸå®ä»·æ ¼)
    set_option('use_real_price', True)
    # è¾“å‡ºå†…å®¹åˆ°æ—¥å¿— log.info()
    log.info('åˆå§‹å‡½æ•°å¼€å§‹è¿è¡Œä¸”å…¨å±€åªè¿è¡Œä¸€æ¬¡')
    # è¿‡æ»¤æ‰orderç³»åˆ—APIäº§ç”Ÿçš„æ¯”errorçº§åˆ«ä½çš„log
    # log.set_level('order', 'error')

    ### è‚¡ç¥¨ç›¸å…³è®¾å®š ###
    # è‚¡ç¥¨ç±»æ¯ç¬”äº¤æ˜“æ—¶çš„æ‰‹ç»­è´¹æ˜¯ï¼šä¹°å…¥æ—¶ä½£é‡‘ä¸‡åˆ†ä¹‹ä¸‰ï¼Œå–å‡ºæ—¶ä½£é‡‘ä¸‡åˆ†ä¹‹ä¸‰åŠ åƒåˆ†ä¹‹ä¸€å°èŠ±ç¨, æ¯ç¬”äº¤æ˜“ä½£é‡‘æœ€ä½æ‰£5å—é’±
    set_order_cost(OrderCost(close_tax=0.001, open_commission=0.0003, close_commission=0.0003, min_commission=5), type='stock')

    ## è¿è¡Œå‡½æ•°ï¼ˆreference_securityä¸ºè¿è¡Œæ—¶é—´çš„å‚è€ƒæ ‡çš„ï¼›ä¼ å…¥çš„æ ‡çš„åªåšç§ç±»åŒºåˆ†ï¼Œå› æ­¤ä¼ å…¥'000300.XSHG'æˆ–'510300.XSHG'æ˜¯ä¸€æ ·çš„ï¼‰
      # å¼€ç›˜å‰è¿è¡Œ
    run_daily(before_market_open, time='before_open', reference_security='000300.XSHG')
      # å¼€ç›˜æ—¶è¿è¡Œ
    run_daily(market_open, time='open', reference_security='000300.XSHG')
      # æ”¶ç›˜åè¿è¡Œ
    run_daily(after_market_close, time='after_close', reference_security='000300.XSHG')

## å¼€ç›˜å‰è¿è¡Œå‡½æ•°
def before_market_open(context):
    # è¾“å‡ºè¿è¡Œæ—¶é—´
    log.info('å‡½æ•°è¿è¡Œæ—¶é—´(before_market_open)ï¼š'+str(context.current_dt.time()))

    # ç»™å¾®ä¿¡å‘é€æ¶ˆæ¯ï¼ˆæ·»åŠ æ¨¡æ‹Ÿäº¤æ˜“ï¼Œå¹¶ç»‘å®šå¾®ä¿¡ç”Ÿæ•ˆï¼‰
    # send_message('ç¾å¥½çš„ä¸€å¤©~')

    # è¦æ“ä½œçš„è‚¡ç¥¨ï¼šæ¯”äºšè¿ªï¼ˆg.ä¸ºå…¨å±€å˜é‡ï¼‰
    g.security = '002594.XSHE'

## å¼€ç›˜æ—¶è¿è¡Œå‡½æ•°
def market_open(context):
    log.info('å‡½æ•°è¿è¡Œæ—¶é—´(market_open):'+str(context.current_dt.time()))
    security = g.security
    # è·å–è‚¡ç¥¨çš„æ”¶ç›˜ä»·
    close_data5 = get_bars(security, count=5, unit='1d', fields=['close'])
    close_data10 = get_bars(security, count=10, unit='1d', fields=['close'])
    # close_data20 = get_bars(security, count=20, unit='1d', fields=['close'])
    # å–å¾—è¿‡å»äº”å¤©ï¼Œåå¤©çš„å¹³å‡ä»·æ ¼
    MA5 = close_data5['close'].mean()
    MA10 = close_data10['close'].mean()
    # å–å¾—ä¸Šä¸€æ—¶é—´ç‚¹ä»·æ ¼
    #current_price = close_data['close'][-1]
    # å–å¾—å½“å‰çš„ç°é‡‘
    cash = context.portfolio.available_cash

    # äº”æ—¥å‡çº¿ä¸Šç©¿åæ—¥å‡çº¿
    if (MA5 > MA10) and (cash > 0):
        # è®°å½•è¿™æ¬¡ä¹°å…¥
        log.info("5æ—¥çº¿é‡‘å‰10æ—¥çº¿ï¼Œä¹°å…¥ %s" % (security))
        # ç”¨æ‰€æœ‰ cash ä¹°å…¥è‚¡ç¥¨
        order_value(security, cash)
    # äº”æ—¥å‡çº¿è·Œç ´åæ—¥å‡çº¿
    elif (MA5 < MA10) and context.portfolio.positions[security].closeable_amount > 0:
        # è®°å½•è¿™æ¬¡å–å‡º
        log.info("5æ—¥çº¿æ­»å‰10æ—¥çº¿, å–å‡º %s" % (security))
        # å–å‡ºæ‰€æœ‰è‚¡ç¥¨,ä½¿è¿™åªè‚¡ç¥¨çš„æœ€ç»ˆæŒæœ‰é‡ä¸º0
        for security in context.portfolio.positions.keys():
            order_target(security, 0)

## æ”¶ç›˜åè¿è¡Œå‡½æ•°
def after_market_close(context):
    log.info(str('å‡½æ•°è¿è¡Œæ—¶é—´(after_market_close):'+str(context.current_dt.time())))
    #å¾—åˆ°å½“å¤©æ‰€æœ‰æˆäº¤è®°å½•
    trades = get_trades()
    for _trade in trades.values():
        log.info('æˆäº¤è®°å½•ï¼š'+str(_trade))
    log.info('ä¸€å¤©ç»“æŸ')
    log.info('##############################################################')
```

åœ¨èšå®½ä¸Šå›æµ‹ç­–ç•¥ç»“æœå¦‚ä¸‹ï¼Œè™½ç„¶ç­–ç•¥æ•´ä½“å…·å¤‡è¾ƒå¥½çš„æ”¶ç›Šï¼Œä½†éœ€è¦æç¤ºçš„æ˜¯è¯¥ç­–ç•¥å¹¶ä¸ç¨³å®šã€‚
1. è¯¥ç­–ç•¥å¸¦å…¥äº†åéªŒçŸ¥è¯†ã€‚å› ä¸ºæˆ‘ä»¬å¤§è‡´çŸ¥é“2018-2020å¹´å·¦å³æ¯”äºšè¿ªå¤„äºä¸Šæ¶¨å‘¨æœŸï¼Œè¯¥å‘¨æœŸå†…åŸºæœ¬ä¸Šäº”æ—¥çº¿åœ¨10æ—¥çº¿ä»¥ä¸Šã€‚
2. è¯¥ç­–ç•¥ä¼šæœ‰å¾ˆå¼ºçš„å›æ’¤ã€‚ä¾‹å¦‚å›æµ‹çš„ååŠæ®µï¼Œè¯¥ç­–ç•¥å·²ç»å¼€å§‹è¾ƒå¤§å¹…åº¦å›æ’¤ï¼Œå› æ­¤éœ€è¦ç»“åˆå…¶ä»–ç­–ç•¥æ¥è¿›è¡Œæ­¢ç›ˆæ­¢æŸã€‚
3. è¯¥ç­–ç•¥å›æµ‹å‘¨æœŸä¸å¤Ÿé•¿ã€‚æœ¬ç­–ç•¥ä»…å›æµ‹äº†ä¸¤å¹´ï¼Œå¹¶ä¸”å¤„äºè¾ƒå¼ºå‘¨æœŸå†…ï¼Œå› æ­¤ä¸å…·å¤‡è¾ƒå¼ºçš„å›æµ‹æ„ä¹‰ã€‚
   
![07_é‡åŒ–å›æµ‹_èšå®½åŒå‡çº¿ç­–ç•¥](ch07_2_JoinQuant_result.png)


## 7.3 Backtraderå¹³å°é‡åŒ–å›æµ‹å®è·µ
### Backtraderç®€ä»‹
Backtraderæ˜¯ä¸€æ¬¾åŸºäºPythonçš„å¼€æºçš„é‡åŒ–å›æµ‹æ¡†æ¶ï¼ŒåŠŸèƒ½å®Œå–„ï¼Œå®‰è£…ç®€å•ã€‚    
Backtraderå®˜æ–¹æ–‡æ¡£(è‹±æ–‡) https://www.backtrader.com/docu/   
Backtraderéå®˜æ–¹æ–‡æ¡£(ä¸­æ–‡) https://www.heywhale.com/mw/project/63857587d0329ee911dcd7f2   


### Backtraderé‡åŒ–å›æµ‹æ¡†æ¶å®è·µ
æœ¬éƒ¨åˆ†å°†ä»‹ç»å¦‚ä½•åœ¨Backtraderå®ç°ä¸€ä¸ªåŒå‡çº¿ç­–ç•¥ï¼ˆå…·ä½“å‚ç…§ch05æ‹©æ—¶ç­–ç•¥ï¼‰ï¼Œå¹¶ä¸”åœ¨è¯¥å¹³å°ä¸Šè¿›è¡Œå›æµ‹ï¼Œ
æ¥æµ‹è¯•æ•´ä½“æ”¶ç›Šç‡ã€‚

ç­–ç•¥ä»£ç å¦‚ä¸‹ï¼Œæ ¸å¿ƒç‚¹æœ‰ï¼š
- é€‰æ‹©æ ‡çš„ä¸ºï¼š002594.XSHE æ¯”äºšè¿ª
- é€‰æ‹©åŸºå‡†ä¸ºï¼š000300.XSHG æ²ªæ·±300
- ç­–ç•¥ä¸ºï¼šå½“5æ—¥çº¿é‡‘å‰10æ—¥çº¿ï¼Œå…¨ä»“ä¹°å…¥ï¼›å½“5æ—¥çº¿æ­»å‰10æ—¥çº¿å…¨ä»“å–å‡ºã€‚
```python
# å¯¼å…¥å‡½æ•°åº“
from __future__ import (absolute_import, division, print_function, unicode_literals) 
import datetime
import pymysql
import pandas as pd
import backtrader as bt
import tushare as ts
import numpy as np


# æ•°æ®è·å–(ä»Tushareä¸­è·å–æ•°æ®)
""" 
æ•°æ®è·å–ä¸€èˆ¬éƒ½æ˜¯é€šè¿‡è¿æ¥æ•°æ®åº“ä»æ•°æ®åº“ä¸­è¯»å–ï¼Œå¯¹äºä¸äº†è§£æ•°æ®åº“æ¥æºçš„æ–°æ‰‹å¯ä»¥ä»Tushareä¸­ç›´æ¥è·å–æ•°æ®
"""
def get_data(stock_code):
    """
    stock_code:è‚¡ç¥¨ä»£ç ,ç±»å‹: str
    return: è‚¡ç¥¨æ—¥çº¿æ•°æ®,ç±»å‹: DataFrame
    """
    token = 'Tushare token'   # å¯é€šè¿‡è¿›å…¥ä¸ªäººä¸»é¡µ-æ¥å£TOKENè·å¾—

    ts.set_token(token)
    pro = ts.pro_api(token)

    data_daily = pro.daily(ts_code = stock_code, start_date='20180101', end_date='20230101')
    data_daily['trade_date'] = pd.to_datetime(data_daily['trade_date'])
    data_daily = data_daily.rename(columns={'vol': 'volume'})
    data_daily.set_index('trade_date', inplace=True) 
    data_daily = data_daily.sort_index(ascending=True)
    dataframe = data_daily
    data_daily['openinterest'] = 0
    dataframe['openinterest'] = 0
    data = bt.feeds.PandasData(dataname=dataframe,
                               fromdate=datetime.datetime(2018, 1, 1),
                               todate=datetime.datetime(2023, 1, 1)
                               )

    return data


# åŒå‡çº¿ç­–ç•¥å®ç°
class DoubleAverages(bt.Strategy):

    # è®¾ç½®å‡çº¿å‘¨æœŸ
    params = (
        ('period_data5', 5),
        ('period_data10', 10)
    )

    # æ—¥å¿—è¾“å‡º
    def log(self, txt, dt=None):
        dt = dt or self.datas[0].datetime.date(0)
        print('%s, %s' % (dt.isoformat(), txt))

    def __init__(self):
        # åˆå§‹åŒ–æ•°æ®å‚æ•°

        self.dataclose = self.datas[0].close   # å®šä¹‰å˜é‡dataclose,ä¿å­˜æ”¶ç›˜ä»·
        self.order = None   # å®šä¹‰å˜é‡order,ç”¨äºä¿å­˜è®¢å•
        self.buycomm = None    # å®šä¹‰å˜é‡buycomm,è®°å½•è®¢å•ä½£é‡‘
        self.buyprice = None    # å®šä¹‰å˜é‡buyprice,è®°å½•è®¢å•ä»·æ ¼

        self.sma5 = bt.indicators.SimpleMovingAverage(self.datas[0], period=self.params.period_data5)  # è®¡ç®—5æ—¥å‡çº¿
        self.sma10 = bt.indicators.SimpleMovingAverage(self.datas[0], period=self.params.period_data10)  # è®¡ç®—10æ—¥å‡çº¿

    def notify_order(self, order):
        if order.status in [order.Submitted, order.Accepted]:  # è‹¥è®¢å•æäº¤æˆ–è€…å·²ç»æ¥å—åˆ™è¿”å›
            return

        if order.status in [order.Completed]:
            if order.isbuy():
                self.log(
                    'Buy Executed, Price: %.2f, Cost: %.2f, Comm: %.2f' %
                    (order.executed.price, order.executed.value, order.executed.comm))

                self.buyprice = order.executed.price
                self.buycomm = order.executed.comm
            else:
                self.log('Sell Executed, Price: %.2f, Cost: %.2f, Comm: %.2f' %
                        (order.executed.price, order.executed.value, order.executed.comm))
            self.bar_executed = len(self)
        elif order.status in [order.Canceled, order.Margin, order.Rejected]:
            self.log('Order Canceled/Margin/Rejected')

        self.order = None


    def notify_trade(self, trade):
        if not trade.isclosed:   # è‹¥äº¤æ˜“æœªå…³é—­åˆ™è¿”å›
            return
        self.log('Operation Profit, Total_Profit %.2f, Net_Profit: %.2f' %
                (trade.pnl, trade.pnlcomm))    # pnlè¡¨ç¤ºç›ˆåˆ©, pnlcommè¡¨ç¤ºæ‰‹ç»­è´¹

    def next(self):   # åŒå‡çº¿ç­–ç•¥é€»è¾‘å®ç°
        self.log('Close: %.2f' % self.dataclose[0])   # æ‰“å°æ”¶ç›˜ä»·æ ¼

        if self.order:   # æ£€æŸ¥æ˜¯å¦æœ‰è®¢å•å‘é€
            return

        if not self.position:   # æ£€æŸ¥æ˜¯å¦æœ‰ä»“ä½
            if self.sma5[0] > self.sma10[0]:
                self.log('Buy: %.2f' % self.dataclose[0])
                self.order = self.buy()

        else:
            if self.sma5[0] < self.sma10[0]:
                self.log('Sell: %.2f' % self.dataclose[0])
                self.order = self.sell()





if __name__ == '__main__':
    cerebro = bt.Cerebro()   # åˆ›å»ºç­–ç•¥å®¹å™¨
    cerebro.addstrategy(DoubleAverages)    # æ·»åŠ åŒå‡çº¿ç­–ç•¥
    data = get_data('000001.SZ')
    cerebro.adddata(data)   # æ·»åŠ æ•°æ®
    cerebro.broker.setcash(10000.0)   # è®¾ç½®èµ„é‡‘
    cerebro.addsizer(bt.sizers.FixedSize, stake=100)   # è®¾ç½®æ¯ç¬”äº¤æ˜“çš„è‚¡ç¥¨æ•°é‡
    cerebro.broker.setcommission(commission=0.01)   # è®¾ç½®æ‰‹ç»­è´¹
    print('Starting Portfolio Value: %.2f' % cerebro.broker.getvalue())   # æ‰“å°åˆå§‹èµ„é‡‘
    cerebro.run()   # è¿è¡Œç­–ç•¥
    print('Final Portfolio Value: %.2f' % cerebro.broker.getvalue())   # æ‰“å°æœ€ç»ˆèµ„é‡‘
    cerebro.plot()
```

![07_é‡åŒ–å›æµ‹_backtrader_result](ch07_3_backtrader_result.png)

## 7.4 BigQuanté‡åŒ–æ¡†æ¶å®æˆ˜

### BigQuantç®€ä»‹
BigQuantæ˜¯ä¸€ä¸ªäººå·¥æ™ºèƒ½é‡åŒ–æŠ•èµ„å¹³å°ã€‚    
BigQuantå®˜ç½‘ https://bigquant.com/


### ç­–ç•¥å®ç°
æœ¬éƒ¨åˆ†å°†ä»‹ç»å¦‚ä½•åœ¨BigQuantå®ç°ä¸€ä¸ªåŒå‡çº¿ç­–ç•¥ï¼ˆå…·ä½“å‚ç…§ch05æ‹©æ—¶ç­–ç•¥ï¼‰ï¼Œå¹¶ä¸”åœ¨è¯¥å¹³å°ä¸Šè¿›è¡Œå›æµ‹ï¼Œ
æ¥æµ‹è¯•æ•´ä½“æ”¶ç›Šç‡ã€‚

ç­–ç•¥ä»£ç å¦‚ä¸‹ï¼Œæ ¸å¿ƒç‚¹æœ‰ï¼š
- é€‰æ‹©æ ‡çš„ä¸ºï¼š600519.SHA è´µå·èŒ…å°ã€601392.SHA å·¥å•†é“¶è¡Œ
- é€‰æ‹©åŸºå‡†ä¸ºï¼š000300.HIX æ²ªæ·±300
- ç­–ç•¥ä¸ºï¼šå½“5æ—¥çº¿é‡‘å‰10æ—¥çº¿ï¼Œå…¨ä»“ä¹°å…¥ï¼›å½“5æ—¥çº¿æ­»å‰10æ—¥çº¿å…¨ä»“å–å‡ºã€‚

```python
from bigdatasource.api import DataSource
from biglearning.api import M
from biglearning.api import tools as T
from biglearning.module2.common.data import Outputs
 
import pandas as pd
import numpy as np
import math
import warnings
import datetime
 
from zipline.finance.commission import PerOrder
from zipline.api import get_open_orders
from zipline.api import symbol
 
from bigtrader.sdk import *
from bigtrader.utils.my_collections import NumPyDeque
from bigtrader.constant import OrderType
from bigtrader.constant import Direction

def m3_initialize_bigquant_run(context):
    context.set_commission(PerOrder(buy_cost=0.0003, sell_cost=0.0013, min_cost=5))


def m3_handle_data_bigquant_run(context, data):
    today = data.current_dt.strftime('%Y-%m-%d')  
    stock_hold_now = {e.symbol: p.amount * p.last_sale_price
                 for e, p in context.perf_tracker.position_tracker.positions.items()}

    cash_for_buy = context.portfolio.cash    
    
    try:
        buy_stock = context.daily_stock_buy[today]  
    except:
        buy_stock=[]  

    try:
        sell_stock = context.daily_stock_sell[today]  
    except:
        sell_stock=[] 
    
    stock_to_sell = [ i for i in stock_hold_now if i in sell_stock ]

    stock_to_buy = [ i for i in buy_stock if i not in stock_hold_now ]  

    stock_to_adjust=[ i for i in stock_hold_now if i not in sell_stock ]
    
    if len(stock_to_sell)>0:
        for instrument in stock_to_sell:
            sid = context.symbol(instrument) 
            cur_position = context.portfolio.positions[sid].amount 
            if cur_position > 0 and data.can_trade(sid):
                context.order_target_percent(sid, 0) 
                cash_for_buy += stock_hold_now[instrument]
    

    if len(stock_to_buy)+len(stock_to_adjust)>0:
        weight = 1/(len(stock_to_buy)+len(stock_to_adjust)) 
        for instrument in stock_to_buy+stock_to_adjust:
            sid = context.symbol(instrument) 
            if  data.can_trade(sid):
                context.order_target_value(sid, weight*cash_for_buy) 

def m3_prepare_bigquant_run(context):
    df = context.options['data'].read_df()

    def open_pos_con(df):
        return list(df[df['buy_condition']>0].instrument)

    def close_pos_con(df):
        return list(df[df['sell_condition']>0].instrument)

    context.daily_stock_buy= df.groupby('date').apply(open_pos_con)

    context.daily_stock_sell= df.groupby('date').apply(close_pos_con)

m1 = M.input_features.v1(
    features="""# #å·å¼€å§‹çš„è¡¨ç¤ºæ³¨é‡Š
# å¤šä¸ªç‰¹å¾ï¼Œæ¯è¡Œä¸€ä¸ªï¼Œå¯ä»¥åŒ…å«åŸºç¡€ç‰¹å¾å’Œè¡ç”Ÿç‰¹å¾
buy_condition=where(mean(close_0,5)>mean(close_0,10),1,0)
sell_condition=where(mean(close_0,5)<mean(close_0,10),1,0)""",
    m_cached=False
)

m2 = M.instruments.v2(
    start_date=T.live_run_param('trading_date', '2019-03-01'),
    end_date=T.live_run_param('trading_date', '2021-06-01'),
    market='CN_STOCK_A',
    instrument_list="""600519.SHA
601392.SHA""",
    max_count=0
)

m7 = M.general_feature_extractor.v7(
    instruments=m2.data,
    features=m1.data,
    start_date='',
    end_date='',
    before_start_days=60
)

m8 = M.derived_feature_extractor.v3(
    input_data=m7.data,
    features=m1.data,
    date_col='date',
    instrument_col='instrument',
    drop_na=False,
    remove_extra_columns=False
)

m4 = M.dropnan.v2(
    input_data=m8.data
)

m3 = M.trade.v4(
    instruments=m2.data,
    options_data=m4.data,
    start_date='',
    end_date='',
    initialize=m3_initialize_bigquant_run,
    handle_data=m3_handle_data_bigquant_run,
    prepare=m3_prepare_bigquant_run,
    volume_limit=0.025,
    order_price_field_buy='open',
    order_price_field_sell='open',
    capital_base=1000000,
    auto_cancel_non_tradable_orders=True,
    data_frequency='daily',
    price_type='åå¤æƒ',
    product_type='è‚¡ç¥¨',
    plot_charts=True,
    backtest_only=False,
    benchmark='000300.HIX'
)

```

![07_é‡åŒ–å›æµ‹_BigQuant_result](ch07_5_BigQuant_result.png)




## 7.5 æ‰‹å†™å›æµ‹ä»£ç  - æ‰‹æŠŠæ‰‹å®ç°ä¸€ä¸ªå‚»ç“œå¼é‡åŒ–å›æµ‹æ¡†æ¶

### ä¸ºä»€ä¹ˆï¼Ÿ

#### ä¸ºä»€ä¹ˆè¦å¼€å‘ï¼Ÿ

1.  ä¸ºäº†é¿å…é‡å¤é€ è½®å­ï¼Œç®€åŒ–ç­–ç•¥çš„å›æµ‹ï¼Œå¼€å‘è¯¥æ¡†æ¶
2.  VNPYç­‰æ¡†æ¶
    1.  è¿‡äºå¤æ‚ï¼Œç»§æ‰¿åµŒå¥—å¤ªå¤šï¼Œä¸æ˜“ç†è§£
    2.  å›æµ‹éœ€å¡«å…¥åˆçº¦åç§°ã€ä¿è¯é‡‘æ¯”ç‡ã€æ‰‹ç»­è´¹ç­‰è¯¦ç»†å‚æ•°ï¼Œä½†å¯¹äºä¸€ä¸ªç­–ç•¥çš„é›å½¢éªŒè¯ï¼Œå¾€å¾€ä¸éœ€è¦è¿™ä¹ˆç²¾ç»†
    3.  æœ‰æ—¶å€™å›æµ‹æ ‡çš„æ˜¯æŒ‡æ•°æˆ–ä¼°å€¼ï¼Œå¸‚åœºä¸Šå¹¶æ²¡æœ‰ç›¸å…³åˆçº¦

#### ä¸ºä»€ä¹ˆå«å‚»ç“œå¼ï¼Ÿ

ğŸ”´  æ— éœ€å®‰è£…ï¼Œåªéœ€å¼•ç”¨ä¸€ä¸ªStupidHead.pyæ–‡ä»¶

ğŸŸ¢  æ¶æ„ç®€å•ï¼Œæ²¡æœ‰å¤æ‚çš„ç±»ç»§æ‰¿åŠåµŒå¥—å…³ç³»ï¼Œçº¯å‡½æ•°æ¨¡å¼

ğŸŸ¡  ç­–ç•¥ç¼–å†™ç®€å•

#### è§£å†³ä»€ä¹ˆç—›ç‚¹ï¼Ÿ

ğŸ”´  å›æµ‹ç»“æœè¡¨ç°æ— éœ€æ‰‹å†™

ğŸŸ¢  å°è£…å¸¸ç”¨æŠ€æœ¯æŒ‡æ ‡

ğŸ”µ  ç­–ç•¥å‚æ•°ä¼˜åŒ–é—®é¢˜

ğŸŸ£  å¯ç›´æ¥å¯¹æ¥æ¨¡æ‹Ÿç›˜ã€å®ç›˜

### æ€ä¹ˆç”¨ï¼Ÿ

#### å¼•å…¥StupidHead.py

-   **talibå®‰è£…**

    æŠ€æœ¯æŒ‡æ ‡åº“ï¼Œè°ƒç”¨C++çš„talibåº“ï¼Œå®‰è£…æœ‰ç‚¹éº»çƒ¦ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š

    ğŸ”´ å…ˆè§£å‹ä¸‹é¢æ–‡ä»¶åˆ°`C:\ta-lib`

    [ta-lib-0.4.0-msvc.zip](file/ta-lib-0.4.0-msvc_A4PDuU5so5.zip "ta-lib-0.4.0-msvc.zip")

    ğŸŸ¢ å®‰è£…C++ç¼–è¯‘åŒ…

    [vc\_redist.x64.exe](file/vc_redist.x64_8NE1PgLK3r.exe "vc_redist.x64.exe")

    ğŸŸ¡  å®‰è£…talib

    Ctrl+F æ‰¾åˆ°å¯¹åº”ç‰ˆæœ¬çš„çš„ta-libåŒ…ï¼Œä¸‹è½½åˆ°æœ¬åœ°ï¼Œpipå®‰è£…

    <https://www.lfd.uci.edu/~gohlke/pythonlibs/>

    ![](image/image_qBP7CUTyP3.png)
    ```python
    pip install TA_Lib-0.4.17-cp37-cp37m-win_amd64.whl
    ```

```python
# %% å¼•å…¥åŒ…
import pandas as pd
import math
import matplotlib.pyplot as plt
import talib  # http://mrjbq7.github.io/ta-lib/doc_index.html
import numpy as np
from sqlalchemy import create_engine
from hyperopt import tpe, hp, fmin, STATUS_OK, Trials
from hyperopt.pyll.base import scope
import importlib
import warnings

warnings.filterwarnings('ignore')

plt.rcParams['font.sans-serif'] = 'SimHei'
plt.rcParams['axes.unicode_minus'] = False


# %% è‡ªå®šä¹‰å‡½æ•°


def setpos(pos, *args):
    HQDf = args[1]
    idx = args[2]
    HQDf.loc[idx, 'pos'] = pos


def CalculateResult(HQDf):
    def get_max_drawdown(array):
        array = pd.Series(array)
        cummax = array.cummax()
        return array / cummax - 1

    # HQDf = HQDf.fillna(method='ffill')
    HQDf = HQDf.fillna(0)
    HQDf['base_balance'] = HQDf.close / HQDf.close[0]  # åŸºå‡†å‡€å€¼
    HQDf['chg'] = HQDf.close.pct_change()  # å•æ—¥æ¶¨è·Œå¹…
    # è®¡ç®—ç­–ç•¥å‡€å€¼
    HQDf['strategy_balance'] = 1.0
    for i in range(0, len(HQDf)):
        if i > 0:
            HQDf.loc[HQDf.index[i], 'strategy_balance'] = HQDf.iloc[i - 1]['strategy_balance'] * (1. + HQDf.iloc[i]['chg'] * HQDf.iloc[i - 1]['pos'])
    HQDf['drawdown'] = get_max_drawdown(HQDf['strategy_balance'])  # å›æ’¤
    StatDf = {}
    StatDf['MaxDrawDown'] = min(HQDf['drawdown'])  # æœ€å¤§å›æ’¤
    StatDf['return'] = HQDf['strategy_balance'][-1] - 1  # åŒºé—´æ”¶ç›Š
    # è®¡ç®—å¹´åŒ–æ”¶ç›Š
    years = (HQDf.index[-1] - HQDf.index[0]).days / 365
    if years <= 1:
        StatDf['yearReturn'] = StatDf['return'] / years
    else:
        StatDf['yearReturn'] = (HQDf['strategy_balance'][-1] / 1) ** (1 / years) - 1
    StatDf['return/maxdrawdown'] = -1 * StatDf['return'] / StatDf['MaxDrawDown']

    # è®¡ç®—å¤æ™®æ¯”
    x = HQDf["strategy_balance"] / HQDf["strategy_balance"].shift(1)
    x[x <= 0] = np.nan
    HQDf["return"] = np.log(x).fillna(0)
    daily_return = HQDf["return"].mean() * 100
    return_std = HQDf["return"].std() * 100
    daily_risk_free = 0.015 / np.sqrt(240)
    StatDf['sharpe_ratio'] = (daily_return - daily_risk_free) / return_std * np.sqrt(240)
    # HQDf = HQDf.dropna()
    return HQDf, StatDf


def plotResult(HQDf):
    fig, axes = plt.subplots(4, 1, figsize=(16, 12))
    HQDf.loc[:, ['base_balance', 'strategy_balance']].plot(ax=axes[0], title='å‡€å€¼æ›²çº¿')
    HQDf.loc[:, ['drawdown']].plot(ax=axes[1], title='å›æ’¤', kind='area')
    HQDf.loc[:, ['pos']].plot(ax=axes[2], title='ä»“ä½', kind='area', stacked=False)
    HQDf['empty'] = HQDf.close[HQDf.pos == 0]
    HQDf['long'] = HQDf.close[HQDf.pos > 0]
    HQDf['short'] = HQDf.close[HQDf.pos < 0]
    HQDf.loc[:, ['long', 'short', 'empty']].plot(ax=axes[3], title='å¼€å¹³ä»“ç‚¹ä½', color=["r", "g", "grey"])
    plt.show()


def CTA(HQDf, loadBars, func, **kwargs):
    HQDf['pos'] = np.nan
    # for idx, hq in tqdm(HQDf.iterrows()):
    for idx, hq in HQDf.iterrows():
        TradedHQDf = HQDf[:idx]
        idx_num = TradedHQDf.shape[0]
        if idx_num < loadBars:
            continue
        func(TradedHQDf, HQDf, idx, idx_num, **kwargs)
        HQDf[:idx].pos = HQDf[:idx].pos.fillna(method='ffill')
    HQDf, StatDf = CalculateResult(HQDf)
    # print(StatDf)
    return HQDf, StatDf


def hypeFun(space, target):
    """
    è´å¶æ–¯è¶…å‚æ•°ä¼˜åŒ–
    :param space: å‚æ•°ç©ºé—´
    :param target: ä¼˜åŒ–ç›®æ ‡
    :return:
    """

    def hyperparameter_tuning(params):
        HQDf, StatDf = CTA(**params)
        return {"loss": -StatDf[target], "status": STATUS_OK}

    trials = Trials()
    best = fmin(
        fn=hyperparameter_tuning,
        space=space,
        algo=tpe.suggest,
        max_evals=100,
        trials=trials
    )

    print("Best: {}".format(best))
    return trials, best


```

```python
from StupidHead import *
```

#### ç¼–å†™ç­–ç•¥

-   ç­–ç•¥é€»è¾‘
    -   `TradedHQDf `
        -   å†å²è¡Œæƒ…`DataFrame`
        -   å‡½æ•°å†…ç¬¬ä¸€è¡Œ `TradedHQDf = args[0]`&#x20;
    -   å¼€å¤šã€å¼€ç©ºã€ç©ºä»“é€šè¿‡`setpos`å‡½æ•°å³å¯ï¼š
        -   setpos(1, \*args)    â€”â€”æ»¡ä»“å¼€å¤š
        -   setpos(-1, \*args)    â€”â€”æ»¡ä»“å¼€ç©º
        -   setpos(0, \*args)    â€”â€”ç©ºä»“
        -   setpos(0.5, \*args)    â€”â€”50%ä»“ä½å¼€å¤š
        -   setpos(-0.5, \*args)    â€”â€”50%ä»“ä½å¼€ç©º

```python
def doubleMa(*args, **kwargs):
    TradedHQDf = args[0]
    fast_ma = talib.SMA(TradedHQDf.close, timeperiod=kwargs['fast'])
    fast_ma0 = fast_ma[-1]
    fast_ma1 = fast_ma[-2]
    slow_ma = talib.SMA(TradedHQDf.close, timeperiod=kwargs['slow'])
    slow_ma0 = slow_ma[-1]
    slow_ma1 = slow_ma[-2]
    cross_over = fast_ma0 > slow_ma0 and fast_ma1 < slow_ma1
    cross_below = fast_ma0 < slow_ma0 and fast_ma1 > slow_ma1
    if cross_over:
        setpos(1, *args)
    elif cross_below:
        setpos(-1, *args)
```

#### å›æµ‹ç­–ç•¥

[T888\_1d.csv](file/T888_1d_j84jdLF4_M.csv "T888_1d.csv")

[T888\_15m.csv](file/T888_15m_H9xjdfqijb.csv "T888_15m.csv")

```python
from stupids.StupidHead import *


def doubleMa(*args, **kwargs):
    TradedHQDf = args[0]
    fast_ma = talib.SMA(TradedHQDf.close, timeperiod=kwargs['fast'])
    fast_ma0 = fast_ma[-1]
    fast_ma1 = fast_ma[-2]
    slow_ma = talib.SMA(TradedHQDf.close, timeperiod=kwargs['slow'])
    slow_ma0 = slow_ma[-1]
    slow_ma1 = slow_ma[-2]
    cross_over = fast_ma0 > slow_ma0 and fast_ma1 < slow_ma1
    cross_below = fast_ma0 < slow_ma0 and fast_ma1 > slow_ma1
    if cross_over:
        setpos(1, *args)
    elif cross_below:
        setpos(-1, *args)


if __name__ == '__main__':
    HQDf = pd.read_csv('data\T888_1d.csv', index_col='date')
    HQDf.index = pd.to_datetime(HQDf.index)
    ctaParas = {'fast': 5, 'slow': 10}
    ResultTSDf, StatDf = CTA(HQDf, 30, doubleMa, **ctaParas)
    plotResult(ResultTSDf)

    


```

#### å‚æ•°ä¼˜åŒ–

> ğŸ“Œé‡‡ç”¨æœºå™¨å­¦ä¹ ä¸­è´å¶æ–¯è¶…å‚æ•°ä¼˜åŒ–æ–¹æ³•ï¼Œä»¥æçŸ­çš„æ—¶é—´å¯»æ‰¾å‡ºæœ€ä¼˜å‚æ•°

```python
# sapce æ˜¯å‚æ•°ç©ºé—´ï¼Œå®šä¹‰è´å¶æ–¯æœç´¢çš„ç©ºé—´
# func æŠ€æœ¯æŒ‡æ ‡åç§°
# fast slow ä¸ºæŠ€æœ¯æŒ‡æ ‡çš„å‚æ•°èŒƒå›´
space = {
        "HQDf": HQDf,
        "loadBars": 40,
        "func": doubleMa,
        "fast": hp.quniform("fast", 3, 30, 1),
        "slow": hp.quniform("slow", 5, 40, 1),
    }

# è°ƒç”¨è´å¶æ–¯æœç´¢ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå‚æ•°ç©ºé—´ï¼Œç¬¬äºŒä¸ªä¸ºä¼˜åŒ–ç›®æ ‡ï¼ˆæ±‚è§£ä¼˜åŒ–ç›®æ ‡æå€¼ï¼‰
trials, best = hypeFun(space, 'sharpe_ratio')

BestResultTSDf, BestStatDf = CTA(HQDf, 30, doubleMa, **best)
plotResult(BestResultTSDf)

```

### æ¡†æ¶åŸç†å’Œç»†èŠ‚

### more

1.  ä¿®æ”¹`setpos(pos, *args)`+è¡Œæƒ…è®¢é˜…ï¼Œå¯ä»¥ç›´æ¥å˜ä¸ºå®ç›˜
2.  å¯ä»¥æ·»åŠ ç»„åˆå›æµ‹åŠŸèƒ½
3.  å®Œå–„ä»£ç å¯è¯»æ€§
